{% extends "user/base.html" %} 
{% block title %}Resources | HoppyWay{% endblock %} 
{% block content %}

<link rel="stylesheet" href="/static/css/user/resources.css" />

<div class="resources-wrapper">
    <div class="resources-header">
        <h1 class="page-title">Mental Health Resources</h1>
        <p class="page-subtitle">
            Curated content to support your journey.
        </p>
        
        <div id="moodContext" style="display:none; margin-top: 15px;">
            <span style="background: rgba(70, 94, 215, 0.1); color: var(--primary-color); padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 0.9rem;">
                <i class="fa-solid fa-heart-pulse"></i> Recommended for: <span id="moodText"></span>
            </span>
        </div>
    </div>

    <div class="resources-grid" id="resourcesContainer">
        <div class="resource-card skeleton-card"></div>
        <div class="resource-card skeleton-card"></div>
        <div class="resource-card skeleton-card"></div>
    </div>
</div>

<script>
    async function loadResources() {
        const container = document.getElementById("resourcesContainer");
        const moodContext = document.getElementById("moodContext");
        const moodText = document.getElementById("moodText");
        
        try {
            // CALL THE NEW API ENDPOINT
            const response = await fetch("/api/content/recommended");
            if (!response.ok) throw new Error("Failed to load resources");

            const data = await response.json();
            const resources = data.resources;

            // Update Header based on Mood
            if (data.current_mood && data.current_mood !== "General") {
                moodText.textContent = data.current_mood + " Mood";
                moodContext.style.display = "block";
            }

            container.innerHTML = "";

            if (resources.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fa-solid fa-folder-open"></i>
                        <p>No specific resources found for your current status.</p>
                    </div>`;
                return;
            }

            resources.forEach((resource) => {
                const card = document.createElement("div");
                card.className = "resource-card fade-in";

                // Handle YouTube Embeds
                let mediaContent = "";
                if (resource.media_url) {
                    const embedUrl = getYouTubeEmbed(resource.media_url);
                    if (embedUrl) {
                        mediaContent = `
                            <div class="video-wrapper">
                                <iframe 
                                    src="${embedUrl}" 
                                    title="YouTube video" 
                                    frameborder="0" 
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                    allowfullscreen>
                                </iframe>
                            </div>`;
                    }
                }

                // Determine if it's a specific Emotion Recommendation
                let badgeClass = "category-badge";
                let badgeText = resource.category || 'General';
                
                // If the resource has a specific emotion tag, show it
                if (resource.emotion) {
                    badgeText += ` â€¢ ${capitalize(resource.emotion)}`;
                }

                card.innerHTML = `
                    ${mediaContent}
                    <div class="card-content">
                        <span class="${badgeClass}">${escapeHtml(badgeText)}</span>
                        <h3>${escapeHtml(resource.title)}</h3>
                        <p>${escapeHtml(resource.description)}</p>
                        
                        ${!mediaContent && resource.media_url ? 
                            `<a href="${resource.media_url}" target="_blank" class="read-more">
                                Read Article <i class="fa-solid fa-arrow-up-right-from-square"></i>
                            </a>` : ''}
                    </div>
                `;

                container.appendChild(card);
            });

        } catch (error) {
            console.error("Error:", error);
            container.innerHTML = `<p class="error-msg">Failed to load resources.</p>`;
        }
    }

    function escapeHtml(text) {
        if (!text) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
    }

    function capitalize(s) {
        return s && s[0].toUpperCase() + s.slice(1);
    }

    function getYouTubeEmbed(url) {
        try {
            if (!url) return null;
            const u = new URL(url.startsWith("//") ? "https:" + url : url);
            const host = u.hostname.toLowerCase();

            if (host.includes("youtu.be")) {
                return `https://www.youtube.com/embed/${u.pathname.slice(1)}`;
            }
            if (host.includes("youtube.com")) {
                if (u.pathname.startsWith("/embed/")) return u.href;
                const v = u.searchParams.get("v");
                if (v) return `https://www.youtube.com/embed/${v}`;
            }
        } catch (e) { return null; }
        return null;
    }

    document.addEventListener("DOMContentLoaded", loadResources);
</script>
{% endblock %}